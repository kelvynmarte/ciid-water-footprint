<!DOCTYPE html>
<link href="https://fonts.googleapis.com/css?family=PT+Mono|PT+Sans:400,700" rel="stylesheet">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="node_modules/jquery/dist/jquery.min.js"></script>

<style>
body {
  overflow: hidden;
}
.chart {
    width: 100%;
}

.country-label {
    font-family: 'PT Mono', monospace;
    font-size: 11px;
    text-anchor: end;
    fill: #919191;
}
.graph-title {
    font-family: 'PT Mono', monospace;
    font-size: 14px;
    text-transform: uppercase;
}
.menu-container {
    position: fixed;
    top: 20px;
    left: 20px;
}
.sort-menu-comtainer {
    font-family: 'PT Mono', monospace;
    font-size: 12px;
    text-transform: uppercase;
    color: #1B63A7;
    border: 2px solid #1B63A7;
    padding: 10px 10px;
}
.sort-menu-comtainer h2 {
    margin: 0 0 10px 0;
}
</style>
<body>
<div class="chart">
</div>

<div class="menu-container">
    <div class="sort-menu-comtainer">
        <h2>Sort By</h2>
        <form>
            <input id="sortbyr1" type="radio" name="sortby" value="region" checked="checked"><label for="sortbyr1">Region</label><br>
            <input id="sortbyr2" type="radio" name="sortby" value="inside"><label for="sortbyr2">Inside Country</label><br>
            <input id="sortbyr3" type="radio" name="sortby" value="outside"><label for="sortbyr3">Outside Country</label><br>
            <input id="sortbyr4" type="radio" name="sortby" value="total"><label for="sortbyr4">Total</label><br>
        </form>
        <h2>Filters</h2>
        <form>
            <input id="capitafilterr1" type="radio" name="capitafilter" value="capita" checked="checked"><label for="capitafilterr1">Per Capita</label><br>
            <input id="capitafilterr2" type="radio" name="capitafilter" value="country"><label for="capitafilterr2">Per Country (log)</label><br>
        </form>
    </div>
</div>

<script>



    var regions = ["OCEANIA","SUB SAHARAN AFRICA","NORTHERN AFRICA","ASIA","NEAR EAST","EASTERN EUROPE","WESTERN EUROPE", "BALTICS","C.W. OF IND. STATES", "LATIN AMERICA", "NORTHERN AMERICA"  ];
    var regionColors = ["#0a0d4f", "#13338e", "#1b63a7 ", "#5b85d4", "#89b6e4 ", "#c0eaff", "#90d7eb", "#70b0c5", "#0195ae", "#446c7f", "#2a434e"];

    var titlePadding = 30;
    var width = window.innerWidth - 20;
    var height = window.innerHeight - titlePadding;
    var dataDisplayRange = width - 600
    var svg = d3.select(".chart").append("svg").attr("width", window.innerWidth).attr("height", window.innerHeight);

    var globalFilters = {perCapita: true, xScaleLog: false};

    var getRowColor = function(d){
        return regionColors[regions.indexOf(d.Region)];
        // return "#0195AE";
    }

    d3.csv("waterFootprint.csv", function(error, data) {

        // Convert strings to numbers.
        data.forEach(function(d) {
            d.InternalTotal = +d.InternalTotal;
            d.InternalTotalCap = +d.InternalTotalCap;
            d.ExternalTotal = +d.ExternalTotal;
            d.ExternalTotalCap = +d.ExternalTotalCap;
            d.Total = +d.Total;
            d.TotalCap = +d.TotalCap;
            d.Country = d.Country.trim();
            d.getInternalTotal = function(){
              if(globalFilters.perCapita){
                return d.InternalTotalCap;
              }else{
                return d.InternalTotal;
              }
            };
            d.getExternalTotal = function(){
              if(globalFilters.perCapita){
                return d.ExternalTotalCap;
              }else{
                return d.ExternalTotal;
              }
            };
            d.getTotal = function(){
              if(globalFilters.perCapita){
                return d.TotalCap;
              }else{
                return d.Total;
              }
            };

        });

        // Sort by region
        data.sort(function(a,b) {
            return regions.indexOf(a.Region) - regions.indexOf(b.Region);
        });

        var xScale = d3.scaleLinear()
        .range([0, dataDisplayRange/2]);

        var xScaleLog = d3.scaleLog()
        .range([0, dataDisplayRange/2]);

        var yScale = d3.scaleLinear()
        .domain([0, data.length])
        .range([titlePadding, height]);



        var updateXScaleDomain = function (){
          var maxOne = d3.max(data, function(d) { return Math.max(d.getExternalTotal(), d.getInternalTotal()); });
          xScale.domain([0, maxOne]);
          xScaleLog.domain([Math.exp(0), maxOne]);
        }

        // Capita Filter
        $("input[name=capitafilter]:radio").change(function (e) {
            switch($(e.target).val()){
                case "capita":
                  globalFilters.perCapita = true;
                  globalFilters.xScaleLog = false;
                break;
                case "country":
                  globalFilters.perCapita = false;
                  globalFilters.xScaleLog = true;
                break;
              }
              var rows = svg.select("g.dataRows").selectAll("rect");
              updateRows(rows);
          });

        // Change sorting
        $("input[name=sortby]:radio").change(function (e) {
                var rows = svg.select("g.dataRows").selectAll("rect");

                switch($(e.target).val()){
                    case "region":
                        rows.sort(function(a,b) {
                            return d3.descending(regions.indexOf(a.Region), regions.indexOf(b.Region));//regions.indexOf(a.Region) - regions.indexOf(b.Region);
                        });
                    break;
                    case "inside":
                        rows.sort(function(a,b) {
                            return d3.descending(a.getInternalTotal(), b.getInternalTotal());
                        });
                    break;
                    case "outside":
                        rows.sort(function(a,b) {
                            return d3.descending(a.getExternalTotal(), b.getExternalTotal());

                        });
                    break;
                    case "total":
                        rows.sort(function(a,b) {
                            return d3.descending(a.getTotal(), b.getTotal());
                        });
                    break;

                }
                // Reselect elements and apply transition
                rows = svg.select("g.dataRows").selectAll("rect");
                rows
                .on("mouseover", mouseOverRow)
                .on("mouseout", mouseOutRow);
                rows.transition()
                .duration(500)
                .attr("y",function(d,i){
                    return yScale(i);
                });
        });

         var mouseOverRow = function(d, i) {
            d3.select(this).attr(
              "fill", "#EDAE00"
            );

            // Draw Row Line
            if(( dataDisplayRange / 2) - xScale(d.getInternalTotal() ) - 10 > 0){
                svg.append("rect")
                .attr("id",  "r" + i)
                .attr("x",  ( width / 2 ) -  (dataDisplayRange / 2))
                .attr("y",  yScale(i) + (yScale(1)/2) - 0.5)
                .attr("height", 1)
                .attr("width", ( dataDisplayRange / 2) - xScale(d.getInternalTotal() ))
                .attr("fill", "#000000")
                .style("opacity", 0.2);
            }

            // Row Label
            svg.append("text")
            .attr("id",  "t" + i)
            .attr("x",  ( width / 2 ) -  (dataDisplayRange / 2) - 30)
            .attr("y",  yScale(i) + 5)
            .attr("font-family", "'PT Mono', monospace")
            .attr("font-size", "13px")
            .attr("text-anchor", "end")
            .text( Math.round(xScale(d.getInternalTotal())));

            // Country Label
            svg.append("text")
            .attr("id",  "country" + i)
            .attr("x",  width  )
            .attr("y",  yScale(i) + 5)
            .attr("class", "country-label")
            .text(d.Country);
          };

          var mouseOutRow = function(d, i) {  // Add interactivity
            d3.select(this).attr(
              "fill", getRowColor(d)
            );
            d3.select("#t" + i).remove();
            d3.select("#r" + i).remove();
            d3.select("#country" + i).remove();
          };

          var updateRows = function(rows) {
            console.log(svg.select("g.graph-title"));
            // svg.select("g.graph-title").moveToFront();
            updateXScaleDomain();

            rows
            .transition()
            .duration(500)
            .attr("width", function(d) {
                return (globalFilters.xScaleLog) ? xScaleLog(d.getTotal()) : xScale(d.getTotal());
            })
            .attr("height", function(d,i) {
                return  yScale(1) - 2 - titlePadding; })
            .attr("y", function(d,i){
                return yScale(i);
            })
            .attr("x", function(d,i){
                return  ( width / 2 ) - (d.getInternalTotal() / d.getTotal()) * ((globalFilters.xScaleLog) ? xScaleLog(d.getInternalTotal()) : xScale(d.getInternalTotal()));
            })
            .attr("fill", function(d) {
                return  getRowColor(d);
            });

            rows
            .on("mouseover", mouseOverRow)
            .on("mouseout", mouseOutRow);
          };




          // Draw Center Border


        var drawGraphTitle = function(){
            var graphTitleTopPadding = 20;
            var graphTitleCenteradding = 2;
            var graphTitleGroup = svg.append("g").attr("class", "graph-title");
            graphTitleGroup.append("rect")
            .attr("x", (width/2) - 1.5)
            .attr("y", 0)
            .attr("height", height)
            .attr("width", 3)
            .attr("fill", "#FFFFFF")
            .attr("pointer-events", "none")
            .style("opacity", 0)
            .transition()
            .duration(800)
            .style("opacity", 1);

            graphTitleGroup.append("text")
                .attr("x",  (width / 2) - graphTitleCenteradding  )
                .attr("y", graphTitleTopPadding)
                .attr("class", "graph-title")
                .attr("text-anchor", "end")
                .attr("fill", "#919191")
                .text("Inside Country");

            graphTitleGroup.append("text")
                .attr("x",  (width / 2) + graphTitleCenteradding  )
                .attr("y", graphTitleTopPadding)
                .attr("class", "graph-title")
                .attr("text-anchor", "start")
                .attr("fill", "#000000")
                .text("Outside Country");
        }
        // Initial create rows
        var rows = svg
        .append("g")
        .attr("class", "dataRows")
        .selectAll("rect")
        .data(data)
        .enter()
        .append("rect")
        .attr("width", 0)
        .attr("height", 0)
        .attr("y", function(d,i){
            return yScale(i);
        })
        .attr("x", width/2);
        drawGraphTitle();
        updateRows(rows);






    });
</script>
</body>
